---
phase: 02-team-size-aware-analysis
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/prompts/decompose-system.md
  - src/lib/decompose.ts
  - src/app/api/decompose/route.ts
autonomous: true

must_haves:
  truths:
    - "The system prompt instructs Claude to calibrate gap severity based on team tier (solo/small/medium/large)"
    - "Claude is instructed to return a confidence field on each gap"
    - "The GapSchema in decompose.ts accepts and defaults the confidence field"
    - "The API route passes teamSize from costContext to decomposeWorkflow()"
    - "Gap severity guidance differs for solo vs small vs medium vs large teams"
  artifacts:
    - path: "src/prompts/decompose-system.md"
      provides: "Team-size calibration instructions for Claude"
      contains: "Team-Size Calibration"
    - path: "src/lib/decompose.ts"
      provides: "GapSchema with confidence field and default"
      contains: "confidence"
    - path: "src/app/api/decompose/route.ts"
      provides: "teamSize threading from request body to decomposeWorkflow"
      contains: "teamSize"
  key_links:
    - from: "src/app/api/decompose/route.ts"
      to: "src/lib/decompose.ts"
      via: "decomposeWorkflow(decomposeRequest, teamSize)"
      pattern: "decomposeWorkflow.*teamSize"
    - from: "src/prompts/decompose-system.md"
      to: "Claude API response"
      via: "Prompt instructions produce team-calibrated gap output"
      pattern: "Team-Size Calibration"
---

<objective>
Wire team-size context through the AI prompt pipeline: add team-size-specific severity calibration instructions to the system prompt, update the Zod schema to accept confidence fields on gaps, and thread teamSize from the API route to decomposeWorkflow.

Purpose: This ensures Claude produces team-calibrated gap analysis (TEAM-02, TEAM-03) and returns confidence indicators (TEAM-05). Without prompt guidance, Claude has no instruction to vary severity by team capacity.

Output: Updated system prompt, Zod schema with confidence, API route passing teamSize to the decompose function.
</objective>

<execution_context>
@C:/Users/Brian/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Brian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-team-size-aware-analysis/02-RESEARCH.md
@.planning/phases/02-team-size-aware-analysis/02-01-SUMMARY.md

@src/prompts/decompose-system.md
@src/lib/decompose.ts
@src/app/api/decompose/route.ts
@src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add team-size calibration section to system prompt</name>
  <files>
    src/prompts/decompose-system.md
  </files>
  <action>
Add a new section to `src/prompts/decompose-system.md` AFTER the existing "## Gap Detection" section and BEFORE "## Health Scoring". This section should be titled "## Team-Size Calibration" and contain approximately 20-25 lines of instruction.

Content for the new section:

```markdown
## Team-Size Calibration

When team context is provided in the workflow description (look for "Team size: N people" in a "## Team & Cost Context" block), calibrate your gap severity and suggestions based on team capacity:

### Solo (1 person):
- single_dependency: Always "high" -- the entire workflow depends on one person. Flag when there is no documentation or fallback procedure.
- bottleneck: "high" if it blocks the solo operator for more than 2 hours.
- Do NOT suggest delegation or cross-training (there is no one to delegate to). Focus on automation, documentation, and async tooling.

### Small team (2-5 people):
- single_dependency: "high" if the person covers 50% or more of the steps.
- bottleneck: "high" if it blocks 2 or more downstream steps.
- Suggest cross-training and documentation as primary mitigations.

### Medium team (6-20 people):
- Use standard severity calibration (your default judgment).
- single_dependency: "medium" unless the person is responsible for 60% or more of steps.
- Suggest role-based ownership and rotation.

### Large team (21+ people):
- single_dependency: Usually "low" unless the person controls a critical chokepoint with no documented backup.
- bottleneck: Focus on process bottlenecks (approvals, handoffs) over individual availability.
- Suggest workflow automation and self-service tooling.

When NO team size is provided, use medium-team defaults and note your assumptions.

For each gap, include a "confidence" field with value "high" or "inferred":
- "high": The gap is clearly evidenced from details in the workflow description.
- "inferred": The gap is estimated based on typical patterns for this team size or workflow type.
```

Also update the JSON schema example in the "## Output" section to include the `confidence` field in the gap object:
- Add `"confidence": "high | inferred"` after the `"impactedRoles"` line in the gap schema.

IMPORTANT: Keep additions concise (under 25 lines for the calibration section). The prompt already has ~100 lines. Bloating it risks degrading Claude's JSON output reliability.
  </action>
  <verify>
Read `src/prompts/decompose-system.md` and confirm the "Team-Size Calibration" section exists between "Gap Detection" and "Health Scoring". Confirm the gap schema in the Output section includes the confidence field. Count total lines -- should be under 130 lines.
  </verify>
  <done>
System prompt contains team-size calibration instructions with 4 team tiers (solo/small/medium/large), each with specific severity guidance. Gap schema in the prompt includes confidence field. Total prompt length stays under 130 lines.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update GapSchema and API route to thread teamSize</name>
  <files>
    src/lib/decompose.ts
    src/app/api/decompose/route.ts
  </files>
  <action>
Update `src/lib/decompose.ts`:

1. Add `confidence` field to the `GapSchema` Zod object:
   ```typescript
   confidence: z.enum(["high", "inferred"]).optional().default("inferred"),
   ```
   Place this after the `impactedRoles` field in the GapSchema.

2. Add post-processing for confidence after the existing gap cleanup (after the `cleanGaps` filter). For each gap in cleanGaps:
   - If teamSize was provided to decomposeWorkflow AND the gap has no confidence (or it's undefined), default to "high" (we assume Claude's team-calibrated output is high confidence when team size is known).
   - If no teamSize was provided AND the gap has no confidence, default to "inferred".

   This is a safety net -- Zod's `.default("inferred")` should handle most cases, but this covers edge cases where Claude returns null or unexpected values.

Update `src/app/api/decompose/route.ts`:

3. Extract `teamSize` from the validated body's costContext and pass it to `decomposeWorkflow`:
   - Before: `result = await decomposeWorkflow(decomposeRequest);`
   - After: `result = await decomposeWorkflow(decomposeRequest, body.costContext?.teamSize);`

   This is a single-line change. The teamSize is already available in `body.costContext` (validated by the existing DecomposeInputSchema).

4. Do NOT change the enrichedDescription team context block -- it already injects team size into the prompt text (lines 26-37 of route.ts). The prompt instructions from Task 1 reference this "## Team & Cost Context" block.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Verify that the GapSchema includes the confidence field by reading decompose.ts. Verify that route.ts passes teamSize to decomposeWorkflow.
  </verify>
  <done>
GapSchema has `confidence: z.enum(["high", "inferred"]).optional().default("inferred")`. API route passes `body.costContext?.teamSize` to `decomposeWorkflow()`. Post-processing fills in confidence defaults based on whether teamSize was provided. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `decompose-system.md` contains "## Team-Size Calibration" section with solo/small/medium/large guidance
3. `decompose-system.md` gap schema includes `confidence` field
4. `decompose.ts` GapSchema includes `confidence: z.enum(["high", "inferred"]).optional().default("inferred")`
5. `route.ts` passes `body.costContext?.teamSize` to `decomposeWorkflow()`
6. Total prompt length is under 130 lines
</verification>

<success_criteria>
- System prompt has team-size calibration instructions that vary by 4 team tiers
- Claude is instructed to return confidence field on each gap
- GapSchema accepts and defaults confidence field via Zod
- API route threads teamSize from costContext to decomposeWorkflow
- Backward compatible: submitting without costContext still works
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-team-size-aware-analysis/02-02-SUMMARY.md`
</output>
