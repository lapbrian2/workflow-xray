---
phase: 08-auth-shareable-links
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - workflow-xray/src/app/api/shares/route.ts
  - workflow-xray/src/app/api/workflows/route.ts
  - workflow-xray/src/lib/db-cascade.ts
  - workflow-xray/src/app/xray/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Authenticated user can create a share link for a workflow via POST /api/shares"
    - "Authenticated user can list share links for a workflow via GET /api/shares?workflowId=X"
    - "Authenticated user can revoke a share link via DELETE /api/shares?token=X"
    - "Deleting a workflow via DELETE /api/workflows?id=X also deletes all its share links"
    - "X-Ray page shows a Share button that opens a share management UI"
    - "Share management UI shows existing links with copy and revoke actions"
  artifacts:
    - path: "workflow-xray/src/app/api/shares/route.ts"
      provides: "Share link CRUD API"
      exports: ["POST", "GET", "DELETE"]
    - path: "workflow-xray/src/lib/db-cascade.ts"
      provides: "Cascade delete orchestrator"
      exports: ["cascadeDeleteWorkflow"]
    - path: "workflow-xray/src/app/api/workflows/route.ts"
      provides: "Modified DELETE handler with cascade"
      contains: "cascadeDeleteWorkflow"
    - path: "workflow-xray/src/app/xray/[id]/page.tsx"
      provides: "Share button and share management panel on X-Ray page"
      contains: "SharePanel"
  key_links:
    - from: "workflow-xray/src/app/api/shares/route.ts"
      to: "workflow-xray/src/lib/db-shares.ts"
      via: "Calls createShareLink, listShareLinks, deleteShareLink"
      pattern: "import.*db-shares"
    - from: "workflow-xray/src/lib/db-cascade.ts"
      to: "workflow-xray/src/lib/db-shares.ts"
      via: "Calls deleteShareLinksForWorkflow during cascade delete"
      pattern: "deleteShareLinksForWorkflow"
    - from: "workflow-xray/src/app/api/workflows/route.ts"
      to: "workflow-xray/src/lib/db-cascade.ts"
      via: "DELETE handler calls cascadeDeleteWorkflow instead of deleteWorkflow"
      pattern: "cascadeDeleteWorkflow"
---

<objective>
Build the share link management APIs (create, list, revoke), implement cascade delete for workflow deletion, and add share management UI to the X-Ray page.

Purpose: SHAR-01 (create share links), SHAR-04 (list/copy/revoke), and SHAR-05 (cascade delete) enable authenticated users to manage share links for their workflows. This plan handles the "management side" of sharing -- creating and controlling access. The "viewing side" (public share page) is in Plan 03.

Output: /api/shares route with POST/GET/DELETE; db-cascade.ts orchestrating cleanup; modified workflows DELETE; Share button + panel on X-Ray page.
</objective>

<execution_context>
@C:/Users/Brian/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Brian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@workflow-xray/src/lib/db-shares.ts
@workflow-xray/src/lib/db.ts
@workflow-xray/src/lib/types.ts
@workflow-xray/src/lib/validation.ts
@workflow-xray/src/lib/api-handler.ts
@workflow-xray/src/lib/api-errors.ts
@workflow-xray/src/lib/rate-limit.ts
@workflow-xray/src/app/api/workflows/route.ts
@workflow-xray/src/app/xray/[id]/page.tsx
@.planning/phases/08-auth-shareable-links/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /api/shares route and db-cascade.ts, modify workflow DELETE</name>
  <files>
    workflow-xray/src/app/api/shares/route.ts
    workflow-xray/src/lib/db-cascade.ts
    workflow-xray/src/app/api/workflows/route.ts
  </files>
  <action>
**Create `src/app/api/shares/route.ts`** -- Share link management API.

All three handlers (POST, GET, DELETE) are protected by the middleware (requires auth cookie). Use `withApiHandler` from `api-handler.ts` and rate limiting from `rate-limit.ts` following the same pattern as `workflows/route.ts`.

**POST** -- Create a share link (SHAR-01):
- Use `withApiHandler` with `schema: CreateShareLinkSchema`
- Rate limit: `shares:create` at 20 per minute
- Validate the workflowId exists by calling `getWorkflow(body.workflowId)` from `db.ts` -- return 404 if not found
- Call `createShareLink(body.workflowId, body.label, body.expiresInDays)` from `db-shares.ts`
- Return 201 with the ShareLink object (include the full URL path: `/share/${shareLink.token}`)

**GET** -- List share links for a workflow (SHAR-04):
- Use `withApiHandler` with `bodyType: "none"`
- Rate limit: `shares:read` at 60 per minute
- Read `workflowId` from query params -- return 400 if missing
- Call `listShareLinks(workflowId)` from `db-shares.ts`
- Return 200 with `{ shares: ShareLink[] }`

**DELETE** -- Revoke a share link (SHAR-04):
- Use `withApiHandler` with `bodyType: "none"`
- Rate limit: `shares:delete` at 20 per minute
- Read `token` from query params -- return 400 if missing
- Call `deleteShareLink(token)` from `db-shares.ts`
- Return 200 with `{ deleted: true }`

**Create `src/lib/db-cascade.ts`** -- Cascade delete orchestrator (SHAR-05):

```typescript
import { deleteWorkflow } from "./db";
import { deleteShareLinksForWorkflow } from "./db-shares";

export async function cascadeDeleteWorkflow(id: string): Promise<{ deleted: boolean; sharesRevoked: number }> {
  // Delete share links first (so they cannot resolve to a deleted workflow)
  const sharesRevoked = await deleteShareLinksForWorkflow(id);
  // Then delete the workflow itself
  const deleted = await deleteWorkflow(id);
  return { deleted, sharesRevoked };
}
```

**Modify `src/app/api/workflows/route.ts`** -- Update the DELETE handler:
- Import `cascadeDeleteWorkflow` from `@/lib/db-cascade`
- Replace `await deleteWorkflow(id)` with `await cascadeDeleteWorkflow(id)`
- Return `{ deleted: true, sharesRevoked: result.sharesRevoked }` instead of `{ deleted: true }`
- Keep all existing rate limiting and validation unchanged
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. File `src/app/api/shares/route.ts` exports POST, GET, DELETE
3. File `src/lib/db-cascade.ts` exports `cascadeDeleteWorkflow`
4. In `src/app/api/workflows/route.ts`, grep for `cascadeDeleteWorkflow` -- confirms it replaced `deleteWorkflow` in DELETE handler
5. Verify `CreateShareLinkSchema` is imported in shares/route.ts
  </verify>
  <done>
/api/shares route handles POST (create), GET (list), DELETE (revoke). Cascade delete orchestrator ensures deleting a workflow also revokes all its share links. Workflow DELETE handler uses cascadeDeleteWorkflow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Share button and management panel to X-Ray page</name>
  <files>
    workflow-xray/src/app/xray/[id]/page.tsx
  </files>
  <action>
Add a Share button and an inline share management panel to the X-Ray detail page. Per user decision: no Zustand store expansion -- use component-local state.

**Share Button** -- Add next to the existing "Download PDF" and "Remediation Plan" buttons in the header action row:
- Button styled like the existing "Re-analyze" button (outline style, font-mono, same sizing)
- Label: "Share" (or "Share (N)" if there are existing shares)
- onClick: toggles `showSharePanel` state (boolean, default false)

**Share Panel** -- Rendered below the header when `showSharePanel` is true:
- A collapsible panel with a subtle border and background (match the style of the cache-hit indicator or team-context banner already in the page)
- Animated entry using the same `fadeInUp` animation used elsewhere

**Panel contents:**

1. **Create section:**
   - Text input for optional label (placeholder: "e.g., For client review")
   - Select/dropdown for expiry: "No expiry", "7 days", "30 days", "90 days"
   - "Create Link" button that calls `POST /api/shares` with `{ workflowId: workflow.id, label, expiresInDays }`
   - On success: add the new share to the local list, show success toast

2. **Existing links section:**
   - Fetch on panel open: `GET /api/shares?workflowId=${workflow.id}`
   - Display as a list, each item showing:
     - Label (or "Untitled link" if no label)
     - Created date (formatted like the existing cached date: month short, day, year)
     - Expiry date if set (or "No expiry")
     - Access count (e.g., "3 views")
     - "Copy Link" button -- copies `${window.location.origin}/share/${token}` to clipboard, shows toast "Link copied"
     - "Revoke" button (red/danger style) -- calls `DELETE /api/shares?token=${token}`, removes from local list, shows toast
   - If no shares exist: "No share links yet"
   - Loading state while fetching

**State management** (all local to XRayPage component):
- `showSharePanel: boolean`
- `shares: ShareLink[]`
- `sharesLoading: boolean`
- `creatingShare: boolean`
- `newShareLabel: string`
- `newShareExpiry: number | undefined` (days)

**Styling:** Follow the existing design system:
- Font families: `var(--font-mono)` for labels/buttons, `var(--font-body)` for descriptions
- Colors: `var(--color-border)`, `var(--color-surface)`, `var(--color-muted)`, `var(--color-accent)`, `var(--color-danger)`
- Border radius: `var(--radius-sm)`, `var(--radius-lg)`
- Use inline styles (consistent with the rest of this page -- it does NOT use Tailwind classes)

Import `ShareLink` type from `@/lib/types` for typing the shares state.

Do NOT create a separate component file -- keep it inline in this page as a sub-component (like the existing `Tag` component at the bottom of the file). The share panel is specific to this page and not reused elsewhere.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. X-Ray page has a "Share" button visible in the header action row
3. Grep for `POST.*api/shares` in the file -- confirms create share API call
4. Grep for `Copy Link` or `clipboard` -- confirms copy functionality exists
5. Grep for `Revoke` -- confirms revoke functionality exists
6. Grep for `ShareLink` import -- confirms type is used
  </verify>
  <done>
X-Ray page has a Share button in the header. Clicking it reveals a panel where users can create share links (with optional label and expiry), see existing links (with access count and dates), copy link URLs to clipboard, and revoke links. All state is component-local per user decision.
  </done>
</task>

</tasks>

<verification>
1. `cd workflow-xray && npx tsc --noEmit` -- zero type errors
2. `src/app/api/shares/route.ts` exports POST, GET, DELETE handlers
3. `src/lib/db-cascade.ts` exports cascadeDeleteWorkflow
4. `src/app/api/workflows/route.ts` uses cascadeDeleteWorkflow in DELETE
5. X-Ray page shows Share button and management panel
6. No existing functionality broken (PDF export, Notion sync, re-analyze all still present)
</verification>

<success_criteria>
- POST /api/shares creates a share link with token, optional label, optional expiry
- GET /api/shares?workflowId=X returns all active share links for that workflow
- DELETE /api/shares?token=X revokes a specific share link
- DELETE /api/workflows?id=X cascade-deletes all associated share links
- X-Ray page has functional share management UI (create, list, copy, revoke)
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-auth-shareable-links/08-02-SUMMARY.md`
</output>
