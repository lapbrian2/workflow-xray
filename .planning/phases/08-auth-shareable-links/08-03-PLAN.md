---
phase: 08-auth-shareable-links
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - workflow-xray/src/app/api/share/[token]/route.ts
  - workflow-xray/src/app/share/[token]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Anyone with a valid share token URL can view the workflow without logging in"
    - "Share view shows the flow diagram (XRayViz component)"
    - "Share view shows the gap analysis (GapAnalysis component)"
    - "Share view shows the health scores (HealthCard component)"
    - "Share view does NOT show edit, delete, re-analyze, or library navigation controls"
    - "Share view does NOT expose costContext, tokenUsage, or description fields"
    - "Expired or revoked share tokens show a clear 'link expired/revoked' message"
    - "Share view has 'Shared via Workflow X-Ray' branding"
  artifacts:
    - path: "workflow-xray/src/app/api/share/[token]/route.ts"
      provides: "Public share token lookup API"
      exports: ["GET"]
    - path: "workflow-xray/src/app/share/[token]/page.tsx"
      provides: "Read-only share view page"
      contains: "XRayViz"
  key_links:
    - from: "workflow-xray/src/app/api/share/[token]/route.ts"
      to: "workflow-xray/src/lib/db-shares.ts"
      via: "Calls getShareLink to resolve token to workflowId"
      pattern: "getShareLink"
    - from: "workflow-xray/src/app/api/share/[token]/route.ts"
      to: "workflow-xray/src/lib/db.ts"
      via: "Calls getWorkflow to fetch workflow data"
      pattern: "getWorkflow"
    - from: "workflow-xray/src/app/share/[token]/page.tsx"
      to: "workflow-xray/src/app/api/share/[token]/route.ts"
      via: "Client-side fetch to load shared workflow data"
      pattern: "fetch.*api/share"
---

<objective>
Build the public share view -- the API route that resolves share tokens to workflow data (without auth) and the read-only page that renders the shared workflow analysis.

Purpose: SHAR-02 (share link grants read-only access without login) and SHAR-03 (share view renders flow diagram, gap analysis, health scores read-only). This is the "consumer side" of sharing -- what the link recipient sees. The route and page are both on public paths that the middleware (Plan 01) allows through without auth.

Output: GET /api/share/[token] returns sanitized workflow data; /share/[token] page renders read-only X-Ray view with branding.
</objective>

<execution_context>
@C:/Users/Brian/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Brian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@workflow-xray/src/lib/db-shares.ts
@workflow-xray/src/lib/db.ts
@workflow-xray/src/lib/types.ts
@workflow-xray/src/app/xray/[id]/page.tsx
@workflow-xray/src/components/xray-viz.tsx
@workflow-xray/src/components/gap-analysis.tsx
@workflow-xray/src/components/health-card.tsx
@.planning/phases/08-auth-shareable-links/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GET /api/share/[token] public endpoint</name>
  <files>workflow-xray/src/app/api/share/[token]/route.ts</files>
  <action>
Create the directory structure `src/app/api/share/[token]/` and the `route.ts` file.

This is a PUBLIC endpoint -- the middleware allows `/api/share/*` through without auth. It resolves a share token to a sanitized workflow.

**GET handler:**

1. Extract `token` from the route params (Next.js dynamic route).

2. Rate limit: Use `rateLimit` from `rate-limit.ts` -- `share:read` at 30 per minute per IP. This prevents token enumeration. Import `getClientIp` for the IP key.

3. Call `getShareLink(token)` from `db-shares.ts`.
   - If null (not found or expired): return 404 with `{ error: { code: "NOT_FOUND", message: "Share link not found or has expired." } }`
   - If found but `expiresAt` is set and is in the past: return 410 (Gone) with `{ error: { code: "EXPIRED", message: "This share link has expired." } }`

4. Fetch the workflow: `getWorkflow(shareLink.workflowId)` from `db.ts`.
   - If null (workflow deleted but share token still exists -- edge case): return 404 with `{ error: { code: "NOT_FOUND", message: "The shared workflow no longer exists." } }`

5. **Sanitize the workflow** before returning. Create a sanitized copy that strips sensitive fields:
   ```typescript
   const sanitized = {
     id: workflow.id,
     decomposition: workflow.decomposition,  // Full decomposition (steps, gaps, health)
     createdAt: workflow.createdAt,
     updatedAt: workflow.updatedAt,
     version: workflow.version,
     // Explicitly OMIT: description, costContext, tokenUsage, extractionSource,
     // _partial, _recoveryReason, cacheHit, cachedAt, promptVersion, modelUsed,
     // parentId, remediationPlan
   };
   ```

6. Return 200 with `{ workflow: sanitized, share: { label: shareLink.label, expiresAt: shareLink.expiresAt } }`.

Do NOT use `withApiHandler` for this route since it is a simple GET with no body parsing needed. Use a plain exported async function with try/catch and the `errorResponse` helper from `api-errors.ts` for error cases. Follow the pattern of the decompose route which also uses plain exports.

Use `NextResponse` from `next/server`. The function signature should be:
```typescript
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ token: string }> }
): Promise<NextResponse>
```
Note: In Next.js 16, route params are a Promise and must be awaited.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. File exists at `src/app/api/share/[token]/route.ts`
3. Grep for `getShareLink` -- confirms token lookup
4. Grep for `getWorkflow` -- confirms workflow fetch
5. Grep for `costContext` with NOT/omit context -- confirms field is stripped (should NOT appear in the sanitized object)
6. Grep for `410` -- confirms expired token handling
  </verify>
  <done>
GET /api/share/[token] resolves share tokens to sanitized workflow data. Returns 404 for invalid tokens, 410 for expired tokens. Strips costContext, tokenUsage, description, and other sensitive fields. Rate limited at 30 req/min per IP.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create /share/[token] read-only page</name>
  <files>workflow-xray/src/app/share/[token]/page.tsx</files>
  <action>
Create the directory structure `src/app/share/[token]/` and the `page.tsx` file.

This is a "use client" page that renders a read-only view of a shared workflow. It is a public page (middleware allows `/share/*` without auth).

**Page structure:**

1. **Data loading:**
   - Use `useParams()` to get the token
   - Fetch `GET /api/share/${token}` on mount (useEffect)
   - Handle loading, error, and success states
   - On error: show a clear message based on status code:
     - 404: "This share link is invalid or the workflow has been deleted."
     - 410: "This share link has expired."
     - Other: "Something went wrong. Please try again."

2. **Layout -- minimal, no app navigation:**
   - Do NOT import or render the Nav component
   - Do NOT show login, library, or any authenticated-user navigation
   - Max width 960px centered (same as xray page)
   - Padding: `clamp(20px, 4vw, 32px) clamp(16px, 4vw, 32px) 64px` (same as xray page)

3. **Header:**
   - Show decomposition title as h1 (same styling as xray page: font-display, font-weight 900, clamp sizing)
   - Show version badge if version > 1 (same as xray page)
   - Show tags: step count, gap count, automation % (reuse the Tag pattern from xray page)
   - Share label if provided (e.g., "Shared: For client review" in a subtle badge)
   - If expiresAt: show "Expires: {formatted date}" in a small muted text
   - Do NOT show: Download PDF, Remediation Plan, Re-analyze, Sync to Notion, Share, View in Library buttons

4. **Tabs and content -- reuse existing components:**
   - Same 3-tab layout as xray page: "Flow Map", "Gaps (N)", "Health"
   - Manage activeTab with local useState (not Zustand -- this page should not interact with the app store)
   - Tab styling: copy the tab-pill pattern from xray page (inline styles)
   - Content panels:
     - Flow Map: `<XRayViz decomposition={workflow.decomposition} />` inside the same container styling
     - Gaps: `<GapAnalysis gaps={workflow.decomposition.gaps} />` (omit teamSize/teamContext since costContext is stripped)
     - Health: `<HealthCard health={workflow.decomposition.health} stepCount={steps.length} gapCount={gaps.length} />`

5. **Branding footer:**
   - At the bottom of the page, a subtle footer:
   - "Shared via Workflow X-Ray" in font-mono, size 11, muted color
   - Centered, with top margin of 48px
   - Optionally link to the app's root URL (but NOT as a deep link into authenticated content)

6. **Loading state:** Match the skeleton pattern from xray page (title skeleton, tab skeleton, content skeleton with pulse animation).

7. **Error state:** Match the error pattern from xray page but without the "Retry" button emphasis. Show the error icon (! in circle), message, and a simple "Go back" link (not to library -- just browser back or a link to the app root).

**Styling:** Use inline styles throughout (consistent with xray page). Use the same CSS variables. Do NOT use Tailwind classes. The existing global CSS (`globals.css`) provides all the variables and animations.

**Important implementation notes:**
- The page must work WITHOUT authentication. It should NOT import anything from `client-db.ts` or `store.ts`.
- The page renders using the same visualization components (XRayViz, GapAnalysis, HealthCard) that the authenticated xray page uses. These components accept props and do not check auth internally.
- The `providers.tsx` wrapper in the app layout includes the Zustand StoreProvider. Since this page does not use the store, this is fine -- it just does not read from it.
- Import the components from their existing paths: `@/components/xray-viz`, `@/components/gap-analysis`, `@/components/health-card`.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. File exists at `src/app/share/[token]/page.tsx`
3. Grep for `XRayViz` -- confirms flow diagram rendered
4. Grep for `GapAnalysis` -- confirms gap analysis rendered
5. Grep for `HealthCard` -- confirms health card rendered
6. Grep for `Shared via Workflow X-Ray` -- confirms branding footer
7. Grep for `client-db` or `saveWorkflowLocal` -- should NOT appear (no auth-dependent imports)
8. Grep for `Download PDF\|Remediation\|Re-analyze\|Notion\|View in Library` -- none should appear (no management actions)
  </verify>
  <done>
/share/[token] page renders a read-only X-Ray view. Shows flow diagram, gap analysis, and health scores using the same components as the authenticated page. No edit/delete/management controls. No navigation to authenticated areas. Handles expired/invalid tokens with clear error messages. Includes "Shared via Workflow X-Ray" branding footer.
  </done>
</task>

</tasks>

<verification>
1. `cd workflow-xray && npx tsc --noEmit` -- zero type errors
2. GET /api/share/[token] returns sanitized workflow data (no costContext, no tokenUsage)
3. GET /api/share/[token] returns 404 for invalid tokens, 410 for expired tokens
4. /share/[token] page renders XRayViz, GapAnalysis, HealthCard in read-only mode
5. /share/[token] page has no authenticated-user controls or navigation
6. /share/[token] page does not import from client-db.ts or store.ts
7. Branding footer present
</verification>

<success_criteria>
- A valid share token URL renders the workflow analysis in read-only mode without requiring login
- The share view shows flow diagram, gap analysis, and health scores (3 tabs)
- The share view does NOT expose costContext, tokenUsage, description, or any sensitive data
- The share view does NOT show editing, deleting, re-analyzing, or any management controls
- Expired/revoked tokens show clear error messages (410 for expired, 404 for invalid)
- "Shared via Workflow X-Ray" branding is visible
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-auth-shareable-links/08-03-SUMMARY.md`
</output>
