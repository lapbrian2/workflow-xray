---
phase: 04-reporting-export
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/chart-data.ts
  - src/components/health-trend-chart.tsx
  - src/app/dashboard/page.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Team dashboard displays health metric trends as line charts showing how complexity, fragility, automation potential, and team load balance change over time"
    - "Trend chart only appears when there are 3 or more data points (workflows), showing an informative empty state otherwise"
    - "Health trend data is derived from existing workflow createdAt timestamps and health scores -- no new storage required"
  artifacts:
    - path: "src/lib/chart-data.ts"
      provides: "Health trend data computation from workflow collection"
      exports: ["computeHealthTrends", "HealthTrendPoint"]
    - path: "src/components/health-trend-chart.tsx"
      provides: "Recharts-based multi-line health trend visualization"
      exports: ["default"]
    - path: "src/app/dashboard/page.tsx"
      provides: "Enhanced dashboard with health trend chart section"
      contains: "HealthTrendChart"
  key_links:
    - from: "src/app/dashboard/page.tsx"
      to: "src/lib/chart-data.ts"
      via: "computeHealthTrends called in useMemo"
      pattern: "computeHealthTrends"
    - from: "src/app/dashboard/page.tsx"
      to: "src/components/health-trend-chart.tsx"
      via: "renders HealthTrendChart component"
      pattern: "<HealthTrendChart"
    - from: "src/components/health-trend-chart.tsx"
      to: "recharts"
      via: "LineChart, Line, XAxis, YAxis, etc."
      pattern: "from.*recharts"
---

<objective>
Add health metric trend charts to the team dashboard using recharts, with data derived from existing workflow timestamps and health scores.

Purpose: REPT-02 requires the dashboard to display health metric trends as visual charts (not just numbers). Currently the dashboard shows static averages and bar visualizations. This plan adds time-series line charts showing how complexity, fragility, automation potential, and team load balance evolve across workflows.
Output: chart-data.ts (data derivation), health-trend-chart.tsx (recharts component), enhanced dashboard/page.tsx
</objective>

<execution_context>
@C:/Users/Brian/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Brian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-reporting-export/04-RESEARCH.md
@src/app/dashboard/page.tsx
@src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install recharts and create health trend data derivation</name>
  <files>
    src/lib/chart-data.ts
    package.json
  </files>
  <action>
1. Install recharts:
   `npm install recharts`
   Recharts 3.7.0 is React 19 compatible (peerDep: ^19.0.0). No version pin needed.

2. Create `src/lib/chart-data.ts` with the health trend computation logic:

   Export `HealthTrendPoint` interface:
   ```typescript
   export interface HealthTrendPoint {
     date: string;                // ISO date (start of period)
     label: string;               // Display label (e.g. "Jan 15")
     count: number;               // Number of workflows in this period
     complexity: number;          // Average complexity score (0-100)
     fragility: number;           // Average fragility score (0-100)
     automationPotential: number; // Average automation potential (0-100)
     teamLoadBalance: number;     // Average team load balance (0-100)
     overallHealth: number;       // Composite health score (0-100)
   }
   ```

   Export `computeHealthTrends(workflows: Workflow[], granularity?: "week" | "month"): HealthTrendPoint[]`:

   Algorithm:
   a. If workflows.length === 0, return empty array
   b. Filter to only workflows that have decomposition with health scores (defensive check)
   c. Group workflows by time period (week or month, default "week"):
      - For week: compute ISO week start (Monday) using the same pattern as the existing `volumeByWeek` in dashboard/page.tsx:
        ```
        const dayOfWeek = weekStart.getDay();
        weekStart.setDate(weekStart.getDate() - ((dayOfWeek + 6) % 7));
        ```
      - For month: use `YYYY-MM-01` format
   d. Sort buckets chronologically
   e. For each bucket, compute the AVERAGE health scores of workflows IN THAT BUCKET (not cumulative):
      - complexity: mean of all workflows in bucket
      - fragility: mean of all workflows in bucket
      - automationPotential: mean of all workflows in bucket
      - teamLoadBalance: mean of all workflows in bucket
      - overallHealth: `Math.round((complexity + (100 - fragility) + automationPotential + teamLoadBalance) / 4)` -- same formula used everywhere else in the codebase
   f. Format label as `"Jan 15"` style using `toLocaleDateString("en-US", { month: "short", day: "numeric" })`
   g. Return the array of HealthTrendPoint sorted by date

   Note on approach: Using per-period averages (not cumulative) is more useful for showing trends. If Period A has 2 workflows averaging 70 health and Period B has 3 workflows averaging 50, the chart shows the decline. Cumulative averaging would dampen this signal.

   Import Workflow type from `@/lib/types`. Access health via `w.decomposition.health`.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm ls recharts` shows recharts installed
3. Verify exports: `grep "export" src/lib/chart-data.ts` shows computeHealthTrends and HealthTrendPoint
4. Verify it imports Workflow from types: `grep "import.*Workflow" src/lib/chart-data.ts`
  </verify>
  <done>
- recharts installed successfully
- chart-data.ts exists with computeHealthTrends function and HealthTrendPoint type
- Function groups workflows by week (default) or month, computes per-period average health scores
- Type-checks pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Create recharts trend chart component and integrate into dashboard</name>
  <files>
    src/components/health-trend-chart.tsx
    src/app/dashboard/page.tsx
  </files>
  <action>
1. Create `src/components/health-trend-chart.tsx` as a "use client" component:

   Import from recharts: LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer
   Import HealthTrendPoint from `@/lib/chart-data`

   Props interface:
   ```typescript
   interface HealthTrendChartProps {
     data: HealthTrendPoint[];
   }
   ```

   Define metric color constants matching the dashboard's existing color scheme:
   ```typescript
   const METRIC_COLORS = {
     complexity: "#2D7DD2",        // blue -- matches colorBlue in PDF
     fragility: "#E8553A",         // red/orange -- matches accent
     automationPotential: "#17A589", // green -- matches colorGreen in PDF
     teamLoadBalance: "#8E44AD",   // purple -- matches colorPurple in PDF
   };
   ```

   Define metric display names for legend:
   ```typescript
   const METRIC_NAMES: Record<string, string> = {
     complexity: "Complexity",
     fragility: "Fragility",
     automationPotential: "Automation",
     teamLoadBalance: "Team Balance",
   };
   ```

   Component implementation:
   - If `data.length < 2`, return null (not enough data points for a trend line)
   - Render inside `<ResponsiveContainer width="100%" height={280}>`
   - Use `<LineChart>` with margin `{ top: 5, right: 20, bottom: 5, left: 0 }`
   - `<CartesianGrid strokeDasharray="3 3" stroke="var(--color-border)" />`
   - `<XAxis dataKey="label">` with tick styling: `fontSize: 10, fontFamily: "var(--font-mono)"`, stroke: `"var(--color-muted)"`
   - `<YAxis domain={[0, 100]}>` with same tick styling
   - `<Tooltip>` with contentStyle using CSS variables: background `var(--color-surface)`, border `1px solid var(--color-border)`, borderRadius 8, fontFamily `var(--font-mono)`, fontSize 11
   - `<Legend>` with wrapperStyle using fontFamily `var(--font-mono)`, fontSize 10
   - Four `<Line>` elements, one per metric:
     - type="monotone", strokeWidth=2, dot={{ r: 3 }}, activeDot={{ r: 5 }}
     - dataKey and stroke from METRIC_COLORS, name from METRIC_NAMES

   Export as default.

2. Integrate into dashboard/page.tsx:

   a. Add imports at top:
      ```typescript
      import { computeHealthTrends } from "@/lib/chart-data";
      import HealthTrendChart from "@/components/health-trend-chart";
      ```

   b. Add a new useMemo after the existing `volumeByWeek` memo (around line 171):
      ```typescript
      const healthTrends = useMemo(() => {
        return computeHealthTrends(workflows);
      }, [workflows]);
      ```

   c. Add the Health Trends section in the JSX. Place it AFTER the "Automation Opportunities" section and BEFORE the "Workflow Volume" section (roughly line 770). Use the existing `Section` component:
      ```jsx
      {healthTrends.length >= 2 && (
        <div style={{ marginTop: 32 }}>
          <Section
            title="Health Trends"
            subtitle={`Health scores across ${healthTrends.reduce((sum, p) => sum + p.count, 0)} workflows over ${healthTrends.length} periods`}
            fullWidth
          >
            <HealthTrendChart data={healthTrends} />
          </Section>
        </div>
      )}
      ```

   d. The threshold is `healthTrends.length >= 2` (at least 2 time periods needed for a line chart to make sense). This matches the existing `volumeByWeek.length > 1` pattern.

   Key styling consideration: The chart should use CSS variables from the existing design system (var(--color-border), var(--color-surface), var(--font-mono), etc.) so it fits seamlessly into the dashboard's visual language. Recharts supports CSS variable strings in style props.

   Important: Mark health-trend-chart.tsx with "use client" directive since recharts measures DOM dimensions for responsive sizing and needs client-side rendering.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` completes successfully
3. Verify health-trend-chart.tsx exists and has recharts imports: `grep "recharts" src/components/health-trend-chart.tsx`
4. Verify dashboard imports the new components: `grep "computeHealthTrends\|HealthTrendChart" src/app/dashboard/page.tsx`
5. Verify the chart renders conditionally: `grep "healthTrends.length" src/app/dashboard/page.tsx`
6. Start dev server briefly to verify no hydration errors: `npx next build` (build covers SSR check)
  </verify>
  <done>
- health-trend-chart.tsx exists as "use client" component with 4 metric lines (complexity, fragility, automation, team balance)
- Dashboard page imports and renders HealthTrendChart inside a Section component
- Chart only renders when 2+ time periods of data exist
- Chart uses CSS variables from design system for consistent styling
- Build and type-check pass with no errors
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes (all files compile, SSR works)
- `npx tsc --noEmit` passes (no type errors)
- recharts installed in node_modules
- chart-data.ts computes health trends from workflow data
- health-trend-chart.tsx renders multi-line recharts chart
- Dashboard page conditionally shows trend chart section
- Chart uses 4 metrics with distinct colors matching the existing PDF/dashboard color scheme
</verification>

<success_criteria>
1. recharts installed and health-trend-chart.tsx renders a multi-line chart with complexity, fragility, automation potential, and team load balance
2. chart-data.ts derives time-series data from existing workflow timestamps/health scores without new storage
3. Dashboard shows "Health Trends" section with the chart when 2+ time periods of data exist
4. Chart integrates with existing design system (CSS variables, font families, color scheme)
5. Build passes with no errors or hydration warnings
</success_criteria>

<output>
After completion, create `.planning/phases/04-reporting-export/04-02-SUMMARY.md`
</output>
