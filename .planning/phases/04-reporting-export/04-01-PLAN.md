---
phase: 04-reporting-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/pdf-shared.ts
  - src/lib/flow-capture.ts
  - src/lib/pdf-export.ts
  - src/lib/pdf-compare-export.ts
  - src/lib/pdf-batch-export.ts
  - src/lib/pdf-remediation-export.ts
autonomous: true

must_haves:
  truths:
    - "PDF export from a workflow includes an embedded flow diagram image between executive summary and gap analysis"
    - "All 4 PDF export files use shared helpers from pdf-shared.ts instead of duplicated inline code"
    - "PDF exports render identically across browsers because they use programmatic jsPDF drawing (already true, must not regress)"
  artifacts:
    - path: "src/lib/pdf-shared.ts"
      provides: "Shared PDF color palette, PdfContext type, checkPageBreak, drawSectionHeader, drawHorizontalRule"
      exports: ["PDF_COLORS", "PdfContext", "checkPageBreak", "drawSectionHeader", "drawHorizontalRule", "parseSeverityColor", "parseLayerColor", "parseHexColor"]
    - path: "src/lib/flow-capture.ts"
      provides: "React Flow viewport capture as PNG data URL"
      exports: ["captureFlowAsDataUrl"]
    - path: "src/lib/pdf-export.ts"
      provides: "Enhanced single-workflow PDF with flow diagram section"
      exports: ["exportToPdf"]
  key_links:
    - from: "src/lib/pdf-export.ts"
      to: "src/lib/pdf-shared.ts"
      via: "import shared helpers"
      pattern: "import.*pdf-shared"
    - from: "src/lib/pdf-export.ts"
      to: "src/lib/flow-capture.ts"
      via: "optional flow diagram capture"
      pattern: "captureFlowAsDataUrl"
    - from: "src/lib/flow-capture.ts"
      to: "html-to-image"
      via: "toPng for viewport capture"
      pattern: "toPng"
---

<objective>
Extract shared PDF utilities from 4 duplicated files, create flow diagram capture utility, and embed flow diagram in the single-workflow PDF export.

Purpose: REPT-01 (cross-browser consistent programmatic PDF) is already satisfied by the existing jsPDF approach -- this plan ensures no regression. REPT-03 requires the flow diagram section (executive summary, gap analysis, and recommendations already exist). Extracting shared helpers reduces ~200 lines of duplicated code across 4 PDF files.
Output: pdf-shared.ts, flow-capture.ts, enhanced pdf-export.ts with flow diagram
</objective>

<execution_context>
@C:/Users/Brian/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Brian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-reporting-export/04-RESEARCH.md
@src/lib/pdf-export.ts
@src/lib/pdf-compare-export.ts
@src/lib/pdf-batch-export.ts
@src/lib/pdf-remediation-export.ts
@src/lib/types.ts
@src/components/xray-viz.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract shared PDF helpers and install html-to-image</name>
  <files>
    src/lib/pdf-shared.ts
    src/lib/flow-capture.ts
    src/lib/pdf-export.ts
    src/lib/pdf-compare-export.ts
    src/lib/pdf-batch-export.ts
    src/lib/pdf-remediation-export.ts
    package.json
  </files>
  <action>
1. Install html-to-image pinned to exactly 1.11.11 (newer versions have confirmed export bugs per React Flow docs):
   `npm install html-to-image@1.11.11`

2. Create `src/lib/pdf-shared.ts` extracting the duplicated helpers from the 4 PDF files:
   - `PDF_COLORS` object with all color tuples: dark, bodyText, muted, accent, border, bgLight, white, blue, red, green, purple, orange
   - `PdfContext` interface: `{ doc: jsPDF; y: number; margin: number; contentWidth: number; pageWidth: number; pageHeight: number }`
   - `checkPageBreak(ctx, needed)` - returns updated ctx (adds page if needed)
   - `drawSectionHeader(ctx, title)` - returns updated ctx
   - `drawHorizontalRule(ctx)` - returns updated ctx
   - `parseSeverityColor(severity)` - returns RGB tuple from SEVERITY_COLORS hex
   - `parseLayerColor(layer)` - returns RGB tuple from LAYER_COLORS hex
   - `parseHexColor(hex)` - general hex-to-RGB utility
   - `createPdfContext(doc)` - factory that creates PdfContext from a jsPDF doc with A4 dimensions
   Note: Functions return updated PdfContext (with new y position) instead of mutating external `y` variable. This is different from the existing pattern where functions mutate a closure variable. The calling code in each PDF file will need to track `ctx` instead of bare `y`.

3. Create `src/lib/flow-capture.ts` with `captureFlowAsDataUrl` function:
   - Import `toPng` from `html-to-image`
   - Import `getNodesBounds`, `getViewportForBounds` from `@xyflow/react`
   - Import `Node` type from `@xyflow/react`
   - Export async function `captureFlowAsDataUrl(nodes: Node[], options?: { width?: number; height?: number; bgColor?: string }): Promise<string>`
   - Default dimensions: 2048x1200 (2x resolution for sharp PDF output at 1024x600 display)
   - Compute nodesBounds and viewport using getNodesBounds/getViewportForBounds with minZoom 0.5, maxZoom 2
   - Query `.react-flow__viewport` element from DOM
   - If not found, throw descriptive error
   - Call toPng with: backgroundColor (default "#FFFFFF"), computed width/height, transform style using viewport.x/y/zoom, filter function that excludes `.react-flow__minimap` and `.react-flow__controls` elements
   - Return the data URL string

4. Refactor all 4 PDF export files to import from pdf-shared.ts:
   - `pdf-export.ts`: Replace inline color constants and helper functions with imports from pdf-shared. Keep the file's unique logic (ROI estimation, action plan generation, cover page, executive summary, etc.) intact. The main change is removing ~50 lines of duplicated color/helper definitions and using `PDF_COLORS` + shared functions instead. Since the existing code uses mutable `y` variable pattern, convert to either: (a) use the shared functions but manage `y` locally by destructuring the returned ctx, or (b) keep local helpers that delegate to shared functions. Option (b) is simpler and less risky -- create thin local wrappers:
     ```
     const colors = PDF_COLORS;
     // Keep local y variable
     function checkPageBreak(needed: number) {
       if (y + needed > pageHeight - 25) { doc.addPage(); y = margin; }
     }
     ```
     Actually, the simplest approach: import `PDF_COLORS` for the color constants (eliminating ~15 lines of color definitions per file), and import `parseHexColor`, `parseSeverityColor`, `parseLayerColor` utilities. Keep the local `checkPageBreak`, `drawSectionHeader`, `drawHorizontalRule` as-is since they close over local `y`. This is the minimal-risk refactor.
   - `pdf-compare-export.ts`: Same pattern -- import PDF_COLORS and parse utilities, keep local helpers
   - `pdf-batch-export.ts`: Same pattern -- import PDF_COLORS and parse utilities, keep local helpers. Note this file has module-level color constants (not inside the function), so replace those with re-exports or direct PDF_COLORS usage.
   - `pdf-remediation-export.ts`: Same pattern -- import PDF_COLORS and parse utilities, keep local helpers. Note: this file uses a DIFFERENT accent color (orange instead of blue) for its specific styling. Keep the local `accent` override: `const accent = PDF_COLORS.orange;`

   The key constraint: DO NOT change the visual output of any existing PDF. The refactor must be purely structural. Every PDF should look exactly the same as before.
  </action>
  <verify>
1. `npx tsc --noEmit` passes with no type errors
2. `npm run build` completes successfully
3. Verify pdf-shared.ts exports exist: `grep -n "export" src/lib/pdf-shared.ts` shows PDF_COLORS, checkPageBreak, drawSectionHeader, drawHorizontalRule, parseSeverityColor, parseLayerColor, parseHexColor, createPdfContext
4. Verify all 4 PDF files import from pdf-shared: `grep "pdf-shared" src/lib/pdf-*.ts` shows 4 matches
5. Verify flow-capture.ts exports captureFlowAsDataUrl: `grep "export" src/lib/flow-capture.ts`
6. Verify html-to-image@1.11.11 installed: `npm ls html-to-image` shows 1.11.11
7. Verify existing PDF sections preserved in pdf-export.ts after refactor: `grep -n "Executive Summary\|Gap Analysis\|Recommendations\|Health Score" src/lib/pdf-export.ts` shows all 4 structured sections still present
8. Verify cross-browser consistency maintained: all PDF files still use only jsPDF programmatic drawing (doc.text, doc.setFont, doc.rect, doc.line) -- no html2canvas or DOM rendering. `grep -L "jsPDF" src/lib/pdf-*.ts` returns empty (all import jsPDF)
  </verify>
  <done>
- pdf-shared.ts exists with exported color palette and utility functions
- flow-capture.ts exists with captureFlowAsDataUrl export
- All 4 PDF export files import PDF_COLORS from pdf-shared.ts (no more duplicated color definitions)
- html-to-image@1.11.11 installed
- Build passes with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Embed flow diagram in single-workflow PDF export</name>
  <files>
    src/lib/pdf-export.ts
  </files>
  <action>
Enhance `exportToPdf` in pdf-export.ts to accept an optional flow diagram data URL and embed it as a new "Flow Diagram" section in the PDF.

1. Update the `exportToPdf` function signature to accept an optional `flowImageDataUrl` parameter:
   ```typescript
   export async function exportToPdf(
     decomposition: Decomposition,
     costContext?: CostContext,
     flowImageDataUrl?: string
   ): Promise<void>
   ```

2. Add a "Flow Diagram" section AFTER the "Health Score Dashboard" section and BEFORE the "Workflow Steps" section. This placement ensures the visual map appears early in the report alongside the health overview, before diving into step-level detail.

3. Flow Diagram section implementation:
   - Call `drawHorizontalRule()` then `drawSectionHeader("Flow Diagram")`
   - Calculate image dimensions maintaining 1024:600 aspect ratio (~1.707:1)
   - `pdfImgWidth = contentWidth` (about 170mm on A4)
   - `pdfImgHeight = pdfImgWidth / 1.707` (about 100mm)
   - Call `checkPageBreak(pdfImgHeight + 12)` -- if the image won't fit, force a new page
   - Use `doc.addImage(flowImageDataUrl, "PNG", margin, y, pdfImgWidth, pdfImgHeight)`
   - Advance `y += pdfImgHeight + 8`
   - Add a subtle border around the diagram: `doc.setDrawColor(...border)`, `doc.setLineWidth(0.3)`, `doc.rect(margin, y - pdfImgHeight - 8, pdfImgWidth, pdfImgHeight, "S")`

4. When `flowImageDataUrl` is not provided (undefined/null), skip the flow diagram section entirely. This maintains backward compatibility -- existing callers that don't pass a flow image get the same PDF as before.

5. Do NOT modify the caller site (the component that calls exportToPdf) in this task. The caller will need to capture the flow diagram and pass it, but that's a UI concern for the component that hosts both the React Flow instance and the export button. Document this in the SUMMARY.

Important: The flow diagram image is captured at 2048x1200 (2x) but displayed at ~170x100mm in the PDF. This 2x capture resolution ensures sharp text and edges in the printed output. Use "PNG" format (not JPEG) to preserve crisp lines and text in the flow nodes.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` completes successfully
3. Verify the flow diagram section exists in pdf-export.ts: `grep -n "Flow Diagram" src/lib/pdf-export.ts` shows the section header
4. Verify addImage call: `grep -n "addImage" src/lib/pdf-export.ts` shows the image embedding
5. Verify backward compatibility: `grep -n "flowImageDataUrl" src/lib/pdf-export.ts` shows optional parameter and conditional check
  </verify>
  <done>
- exportToPdf accepts optional flowImageDataUrl parameter
- When provided, PDF includes "Flow Diagram" section with embedded PNG between Health Dashboard and Workflow Steps
- When not provided, PDF output is unchanged from current behavior
- Image rendered at full content width with correct aspect ratio
- Build passes with no errors
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes (all files compile)
- `npx tsc --noEmit` passes (no type errors)
- pdf-shared.ts exists with shared utilities
- flow-capture.ts exists with capture function
- pdf-export.ts has optional flow diagram embedding
- All 4 PDF files use PDF_COLORS from shared module
- No visual regression in existing PDF outputs (verified structurally -- same drawing calls, just imported constants)
- All 4 structured PDF sections (Executive Summary, Gap Analysis, Recommendations, Health Score Dashboard) remain present in pdf-export.ts after refactor
- Cross-browser consistency: all PDF files use only jsPDF programmatic drawing primitives (no html2canvas/DOM rendering)
</verification>

<success_criteria>
1. Shared PDF utilities extracted -- PDF_COLORS and parse functions imported by all 4 PDF files
2. Flow diagram capture utility created with html-to-image@1.11.11
3. Single-workflow PDF export optionally includes flow diagram section
4. Backward compatibility: existing callers produce identical PDFs (all 4 structured sections preserved)
5. Cross-browser consistency maintained: all PDFs use only jsPDF programmatic drawing (no DOM rendering)
6. Build and type-check pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-reporting-export/04-01-SUMMARY.md`
</output>
