---
phase: 05-debt-closure-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/xray/[id]/page.tsx
  - src/lib/pdf-export.ts
  - src/lib/types.ts
autonomous: true

must_haves:
  truths:
    - "Xray page shows a visible warning banner when viewing partial/recovered analysis results"
    - "PDF exports include team size tier, calibration context, and confidence indicators alongside health scores"
    - "Single-workflow PDF export contains the flow diagram image captured from React Flow"
  artifacts:
    - path: "src/app/xray/[id]/page.tsx"
      provides: "Partial result warning banner and flow capture wiring for PDF export"
      contains: "_partial"
    - path: "src/lib/pdf-export.ts"
      provides: "Team context section and confidence badges in PDF output"
      contains: "teamSize"
    - path: "src/lib/types.ts"
      provides: "Workflow type with _partial and _recoveryReason fields"
      contains: "_partial"
  key_links:
    - from: "src/app/api/decompose/route.ts"
      to: "src/lib/types.ts"
      via: "Workflow object includes _partial/_recoveryReason from decomposeWorkflow"
      pattern: "_partial"
    - from: "src/app/xray/[id]/page.tsx"
      to: "src/lib/flow-capture.ts"
      via: "captureFlowAsDataUrl called before exportToPdf"
      pattern: "captureFlowAsDataUrl"
    - from: "src/app/xray/[id]/page.tsx"
      to: "src/lib/pdf-export.ts"
      via: "flowImageDataUrl passed as third argument to exportToPdf"
      pattern: "exportToPdf.*flowImageDataUrl"
---

<objective>
Close three v1.0 display-layer debt items: add partial result warning banner to xray page, enrich PDF exports with team context and confidence indicators, and wire flow diagram capture into the PDF export button.

Purpose: Users viewing partial/recovered analyses are warned about incomplete results. PDF reports become self-contained with team calibration context and flow diagrams.
Output: Three targeted fixes across 3 files, no new files created.
</objective>

<execution_context>
@C:/Users/Brian/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Brian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/xray/[id]/page.tsx
@src/lib/pdf-export.ts
@src/lib/pdf-shared.ts
@src/lib/flow-capture.ts
@src/lib/types.ts
@src/lib/team-calibration.ts
@src/app/api/decompose/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add partial result warning banner and persist _partial flag on Workflow</name>
  <files>src/lib/types.ts, src/app/api/decompose/route.ts, src/app/xray/[id]/page.tsx</files>
  <action>
1. In `src/lib/types.ts`, add two optional fields to the `Workflow` interface:
   - `_partial?: boolean` -- true when analysis was recovered from malformed AI output
   - `_recoveryReason?: string` -- explanation of what was recovered

2. In `src/app/api/decompose/route.ts`, the `_partial` and `_recoveryReason` are already destructured from `decomposeWorkflow` result on line 95. Currently they are excluded from the workflow object. Change the workflow construction (around line 119-141) to include them:
   - After the existing spread operators, add: `...(_partial ? { _partial, _recoveryReason } : {})`

3. In `src/app/xray/[id]/page.tsx`, add a warning banner that appears when `workflow._partial` is truthy. Place it ABOVE the team context banner (before line 586), right after the header section closes. The banner should:
   - Use amber/warning colors: background `rgba(212, 160, 23, 0.06)`, border `rgba(212, 160, 23, 0.2)`
   - Display a warning icon (unicode triangle: \u26A0) followed by "Partial Results" in bold
   - Show the recovery reason text from `workflow._recoveryReason` if available, otherwise "This analysis was recovered from incomplete AI output. Some details may be missing."
   - Use `fontFamily: "var(--font-body)"`, `fontSize: 12` for the message
   - Match the existing banner pattern (flexbox row, rounded corners, padding 10px 14px)
   - Add `data-testid="partial-warning"` attribute for future testing
  </action>
  <verify>Run `npx tsc --noEmit` to confirm no type errors. Visually confirm in the xray page code that the warning banner renders conditionally on `workflow._partial`.</verify>
  <done>Workflow type includes _partial and _recoveryReason. Decompose route persists these flags. Xray page shows amber warning banner when _partial is true.</done>
</task>

<task type="auto">
  <name>Task 2: Add team context and confidence indicators to PDF exports</name>
  <files>src/lib/pdf-export.ts</files>
  <action>
In `src/lib/pdf-export.ts`, add a "Team Context & Confidence" section to the PDF. Place it between the Executive Summary and Key Metrics sections (after line 362, before the `drawHorizontalRule()` on line 365).

The section should render ONLY when `costContext?.teamSize` is defined. When it renders:

1. Draw a section header "Team Calibration Context" using `drawSectionHeader()`.

2. Create a compact info box (bgLight background, rounded corners):
   - Line 1: "Team Size: {teamSize} people ({tierLabel} tier)" where tierLabel is derived from teamSize using the same logic as team-calibration.ts: <=1 = "Solo", 2-5 = "Small", 6-20 = "Medium", 21+ = "Large". Import `getTeamTier` from `@/lib/team-calibration` (it is NOT a "use client" module -- but pdf-export.ts IS "use client", so this import works fine since both run client-side).
   - Line 2: If `costContext.teamContext` exists, show "Context: {teamContext}"
   - Line 3: "Calibration: Scores adjusted for {tierLabel}-team thresholds" with a brief note that smaller teams see amplified fragility scores.

3. Next to each health score bar in the Health Score Dashboard section (the `healthMetrics.forEach` loop starting around line 413), add a confidence badge:
   - If the `decomposition.health.confidence` exists and `confidence.level === "high"`, show a small green "(calibrated)" label after the score
   - If `confidence.level === "inferred"`, show a small muted "(estimated)" label after the score
   - Use font size 7, positioned to the left of the score value on the right side

Keep all existing PDF layout intact. The team context section adds ~20-25mm of vertical content.
  </action>
  <verify>Run `npx tsc --noEmit`. Read the modified pdf-export.ts and confirm the team calibration section is present and conditional on `costContext?.teamSize`.</verify>
  <done>PDF exports include team size tier, calibration context description, and confidence indicators (calibrated/estimated) next to health scores when team size is provided.</done>
</task>

<task type="auto">
  <name>Task 3: Wire flow diagram capture to PDF export button</name>
  <files>src/app/xray/[id]/page.tsx</files>
  <action>
In `src/app/xray/[id]/page.tsx`, wire `captureFlowAsDataUrl` into the PDF export flow. The `exportToPdf` function already accepts an optional third parameter `flowImageDataUrl: string`.

1. Add import at the top: `import { captureFlowAsDataUrl } from "@/lib/flow-capture";`

2. The xray-viz component renders React Flow nodes. We need access to the nodes for capture. However, `captureFlowAsDataUrl` also needs the nodes array from React Flow. Looking at the function signature: `captureFlowAsDataUrl(nodes: Node[])` -- it uses `getNodesBounds(nodes)` and queries `.react-flow__viewport` from the DOM.

   The simplest approach that avoids refactoring XRayViz: use a ref-based approach. The React Flow viewport element already exists in the DOM when the flow tab is active. We can capture it by:
   - NOT passing nodes -- instead, modify the capture approach. Actually, `captureFlowAsDataUrl` requires nodes. We need to get nodes from the XRayViz component.

   Better approach: Add a `ref` callback to XRayViz that exposes a capture function, OR simply build the nodes from `decomposition.steps` the same way XRayViz does internally.

   Simplest correct approach: In `handleExportPdf`, before calling `exportToPdf`, check if the flow tab is active (`activeTab === "flow"`). If so, attempt to capture. If not active, temporarily skip the flow image (PDF already handles `flowImageDataUrl` being undefined gracefully).

   Actually, the most reliable approach: Always attempt capture regardless of active tab, but wrap in try/catch since the viewport may not be mounted. The `captureFlowAsDataUrl` function throws if `.react-flow__viewport` is not found.

   Implementation:
   - In `handleExportPdf`, BEFORE the `exportToPdf` call, add:
     ```
     let flowImageDataUrl: string | undefined;
     try {
       // Build minimal node array from decomposition for bounds calculation
       const nodes = decomposition.steps.map((step, i) => ({
         id: step.id,
         position: { x: 0, y: i * 100 },
         data: { label: step.name },
       }));
       flowImageDataUrl = await captureFlowAsDataUrl(nodes as any);
     } catch {
       // Flow viewport not mounted or capture failed -- PDF renders without diagram
     }
     ```

   Wait -- this won't work correctly because `captureFlowAsDataUrl` uses `getNodesBounds(nodes)` which needs the actual positioned nodes from React Flow's internal state, not fake positions. The bounds determine the viewport transform for the capture.

   Better approach: Look at how XRayViz constructs nodes. The actual node positions are computed by React Flow's layout. We cannot reconstruct them outside the component.

   Correct approach: Have XRayViz expose its nodes via a ref or callback. But that requires modifying XRayViz.

   Simplest correct approach that avoids modifying XRayViz: The `captureFlowAsDataUrl` function uses `getNodesBounds(nodes)` to compute the viewport transform, but the actual capture uses `toPng(viewportEl, { style: { transform: ... } })`. If we pass dummy nodes, the bounds will be wrong and the capture will be incorrectly framed.

   REVISED APPROACH: Instead of using `captureFlowAsDataUrl` which needs accurate node positions, capture the viewport element directly using `toPng` from `html-to-image` with a simpler approach:

   In `handleExportPdf`:
   ```typescript
   let flowImageDataUrl: string | undefined;
   try {
     const { toPng } = await import("html-to-image");
     const viewportEl = document.querySelector(".react-flow__viewport") as HTMLElement | null;
     if (viewportEl) {
       flowImageDataUrl = await toPng(viewportEl, {
         backgroundColor: "#FFFFFF",
         width: 2048,
         height: 1200,
         filter: (node: HTMLElement) => {
           const cl = node.classList;
           if (!cl) return true;
           return !cl.contains("react-flow__minimap") && !cl.contains("react-flow__controls");
         },
       });
     }
   } catch {
     // Flow viewport not mounted or capture failed -- PDF will render without diagram section
   }
   ```

   Then pass it: `await exportToPdf(workflow.decomposition, workflow.costContext, flowImageDataUrl);`

   This captures whatever is currently rendered in the React Flow viewport. If the user is on the flow tab, it captures perfectly. If on another tab, the viewport element won't exist and we gracefully skip.

   IMPORTANT: To ensure the flow diagram is always captured regardless of active tab, switch to the flow tab momentarily before capture:

   Actually, the simplest user-friendly approach: Just attempt the capture. If the viewport exists (flow tab was visited at least once and React Flow is mounted), capture it. If not, the PDF omits the diagram. This matches the `exportToPdf` signature where `flowImageDataUrl` is optional.

3. Update the `handleExportPdf` function to attempt flow capture before calling `exportToPdf`, passing the result as the third argument. Use the direct `toPng` approach above (not `captureFlowAsDataUrl`) to avoid the node-position dependency.

4. Update the `exportToPdf` call on line 40 from:
   `await exportToPdf(workflow.decomposition, workflow.costContext);`
   to:
   `await exportToPdf(workflow.decomposition, workflow.costContext, flowImageDataUrl);`
  </action>
  <verify>Run `npx tsc --noEmit`. Verify the handleExportPdf function attempts toPng capture and passes the result to exportToPdf.</verify>
  <done>PDF export button captures the React Flow viewport (when mounted) and embeds it in the PDF. When the flow tab hasn't been visited, the PDF gracefully omits the diagram section.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. In src/lib/types.ts: Workflow interface has `_partial?: boolean` and `_recoveryReason?: string`
3. In src/app/api/decompose/route.ts: `_partial` and `_recoveryReason` are spread into the workflow object
4. In src/app/xray/[id]/page.tsx: Warning banner conditionally renders when `workflow._partial` is true
5. In src/lib/pdf-export.ts: Team Calibration Context section renders when `costContext?.teamSize` is defined
6. In src/lib/pdf-export.ts: Confidence badges appear next to health score values
7. In src/app/xray/[id]/page.tsx: handleExportPdf attempts flow capture via toPng and passes result to exportToPdf
</verification>

<success_criteria>
- Partial analysis results show visible amber warning banner on xray page
- PDF exports include team size, tier label, calibration context, and confidence indicators when team size was provided
- PDF export button captures flow diagram from React Flow viewport and embeds it in the PDF
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-debt-closure-test-infrastructure/05-01-SUMMARY.md`
</output>
