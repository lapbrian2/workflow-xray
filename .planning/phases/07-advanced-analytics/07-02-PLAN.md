---
phase: 07-advanced-analytics
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/components/analytics/cost-breakdown.tsx
  - src/components/analytics/gap-heatmap.tsx
  - src/app/dashboard/page.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Dashboard shows API cost breakdown with total tokens, estimated cost, cache hits, and savings"
    - "Dashboard shows a gap frequency heatmap revealing which gap types appear most with severity breakdown"
    - "Dashboard renders all 4 new analytics sections below existing content"
    - "Version trajectory section includes a workflow selector dropdown to pick which workflow's version chain to view"
    - "All analytics compute client-side from the already-fetched workflows array (no new API calls)"
  artifacts:
    - path: "src/components/analytics/cost-breakdown.tsx"
      provides: "ANLZ-03 API cost and cache savings display"
      min_lines: 40
    - path: "src/components/analytics/gap-heatmap.tsx"
      provides: "ANLZ-04 gap frequency heatmap visualization"
      min_lines: 50
    - path: "src/app/dashboard/page.tsx"
      provides: "Dashboard with all 4 new analytics sections integrated"
      contains: "computeVersionTrajectory"
  key_links:
    - from: "src/components/analytics/cost-breakdown.tsx"
      to: "src/lib/analytics.ts"
      via: "uses CostAnalyticsData type"
      pattern: "import.*from.*@/lib/analytics"
    - from: "src/components/analytics/gap-heatmap.tsx"
      to: "src/lib/analytics.ts"
      via: "uses GapPatternData type"
      pattern: "import.*from.*@/lib/analytics"
    - from: "src/app/dashboard/page.tsx"
      to: "src/lib/analytics.ts"
      via: "calls all 4 compute functions in useMemo hooks"
      pattern: "computeVersionTrajectory|computeBatchTrends|computeCostAnalytics|computeGapPatterns"
    - from: "src/app/dashboard/page.tsx"
      to: "src/components/analytics/"
      via: "imports and renders all 4 analytics components"
      pattern: "import.*from.*@/components/analytics"
---

<objective>
Create the remaining two analytics components (ANLZ-03 cost breakdown, ANLZ-04 gap heatmap) and integrate all four analytics sections into the existing dashboard page.

Purpose: Complete the analytics dashboard by adding cost/cache savings visibility and gap frequency patterns, then wire everything into the dashboard so users see all four new analytics sections when they visit /dashboard.

Output: Two new components plus an updated dashboard page rendering all analytics.
</objective>

<execution_context>
@C:/Users/Brian/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Brian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/lib/types.ts
@src/lib/analytics.ts
@src/app/dashboard/page.tsx
@src/components/analytics/version-trajectory.tsx
@src/components/analytics/batch-trends.tsx
@.planning/phases/07-advanced-analytics/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ANLZ-03 cost breakdown and ANLZ-04 gap heatmap components</name>
  <files>src/components/analytics/cost-breakdown.tsx, src/components/analytics/gap-heatmap.tsx</files>
  <action>
**cost-breakdown.tsx (ANLZ-03):**
- `"use client"` directive.
- Import `CostAnalyticsData` from `@/lib/analytics`.
- Props: `{ data: CostAnalyticsData }`.
- Layout: A card-style layout with two rows.
  - **Row 1**: 4 stat boxes in a grid (same styling as existing dashboard HealthStat cards -- surface bg, border, rounded, center-aligned):
    - "Total Analyses": `data.totalAnalyses` (number)
    - "Cache Hits": `data.cacheHits` with percentage `Math.round(data.cacheHits / data.totalAnalyses * 100)%` -- color green if > 0
    - "API Cost": `$${data.totalCost.toFixed(2)}` -- format as currency
    - "Cache Savings": `~$${data.estimatedSavings.toFixed(2)}` -- color green, show "saved" label
  - **Row 2**: Token usage detail bar showing input vs output tokens as a stacked horizontal bar.
    - Left label: "Input: X tokens" (blue #2D7DD2)
    - Right label: "Output: Y tokens" (purple #8E44AD)
    - Bar width proportional to token count ratio
    - Below bar: "Avg cost per analysis: $X.XX"
  - If `data.totalAnalyses === 0`, show message: "No analyses yet -- decompose some workflows to see cost analytics" in muted style.
- Format large token numbers with comma separators (use `toLocaleString()`).
- Component name: `CostBreakdown`, default export.

**gap-heatmap.tsx (ANLZ-04):**
- `"use client"` directive.
- Import `GapPatternData` from `@/lib/analytics`.
- Import `SEVERITY_COLORS` from `@/lib/types`.
- Props: `{ data: GapPatternData[], totalWorkflows: number }`.
- Layout: A visual heatmap-style grid, NOT a Recharts chart (use CSS grid for more control and better visual impact).
  - Each gap type gets a row.
  - Columns: Gap Type Label | Severity Blocks | Count | % Affected
  - **Severity Blocks**: Render a row of small colored squares/cells -- one per gap instance, colored by severity (high=#E8553A, medium=#D4A017, low=#17A589). If more than 20 instances, show 20 blocks with "+N more" label. This creates the visual "heatmap" effect.
  - **% Affected**: `data.percentAffected`% of workflows -- render as a small inline bar (similar to existing dashboard bar patterns).
  - Sort order: already sorted by total count descending from analytics.ts.
- Below the grid, show a legend row: colored squares for high/medium/low severity with labels.
- If data is empty, show: "No gaps detected across your workflows" in muted style with a green checkmark indicator.
- Style the heatmap rows with subtle alternating backgrounds (`var(--color-surface)` and `var(--color-surface-alt)`) for readability.
- Component name: `GapHeatmap`, default export.

Match existing project styling conventions throughout (font-mono, font-body, CSS variables, inline styles).
  </action>
  <verify>
Run `npx tsc --noEmit` from project root -- both files compile with no type errors. Verify both files exist and default-export their components.
  </verify>
  <done>
`cost-breakdown.tsx` renders API cost stats with cache savings prominently displayed and token usage bar. `gap-heatmap.tsx` renders a visual grid of gap types with colored severity blocks creating a heatmap effect. Both handle empty states gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate all 4 analytics sections into dashboard page</name>
  <files>src/app/dashboard/page.tsx</files>
  <action>
Modify the existing `dashboard/page.tsx` to import and render all 4 new analytics components. Read the current file first before making changes.

**New imports to add (at top of file):**
```typescript
import { computeVersionTrajectory, computeBatchTrends, computeCostAnalytics, computeGapPatterns } from "@/lib/analytics";
import VersionTrajectoryChart from "@/components/analytics/version-trajectory";
import BatchTrendsChart from "@/components/analytics/batch-trends";
import CostBreakdown from "@/components/analytics/cost-breakdown";
import GapHeatmap from "@/components/analytics/gap-heatmap";
```

**New state for version trajectory workflow selector:**
```typescript
const [selectedTrajectoryId, setSelectedTrajectoryId] = useState<string | null>(null);
```

**New useMemo hooks (add after existing `healthTrends` memo, before the loading check):**

```typescript
// Version trajectory for selected workflow
const versionTrajectory = useMemo(() => {
  if (!selectedTrajectoryId) return [];
  return computeVersionTrajectory(workflows, selectedTrajectoryId);
}, [workflows, selectedTrajectoryId]);

// Batch trends across all workflows
const batchTrends = useMemo(() => {
  return computeBatchTrends(workflows);
}, [workflows]);

// Cost analytics
const costAnalytics = useMemo(() => {
  return computeCostAnalytics(workflows);
}, [workflows]);

// Gap patterns
const gapPatterns = useMemo(() => {
  return computeGapPatterns(workflows);
}, [workflows]);

// Workflows with version chains (for the trajectory dropdown)
const versionedWorkflows = useMemo(() => {
  return workflows.filter(w => w.parentId || workflows.some(other => other.parentId === w.id));
}, [workflows]);
```

**Auto-select first versioned workflow**: When `versionedWorkflows` changes and `selectedTrajectoryId` is null, auto-select the first one:
```typescript
useEffect(() => {
  if (versionedWorkflows.length > 0 && !selectedTrajectoryId) {
    setSelectedTrajectoryId(versionedWorkflows[0].id);
  }
}, [versionedWorkflows, selectedTrajectoryId]);
```

**New JSX sections (add AFTER the existing "Workflow Volume" section, BEFORE the closing `</div>`):**

Wrap all 4 new analytics sections in a container div with a section header:

```jsx
{/* -- Advanced Analytics -- */}
<div style={{ marginTop: 48 }}>
  <h2 style={{ fontSize: 18, fontWeight: 800, fontFamily: "var(--font-display)", color: "var(--color-dark)", letterSpacing: "-0.01em", marginBottom: 4 }}>
    Advanced Analytics
  </h2>
  <p style={{ fontFamily: "var(--font-body)", fontSize: 13, color: "var(--color-muted)", marginBottom: 24 }}>
    Deeper operational intelligence across your workflow library
  </p>
```

Then render in this order:

1. **Cost Breakdown (ANLZ-03)** -- full width Section, title "API Cost & Cache Savings":
   ```jsx
   <Section title="API Cost & Cache Savings" subtitle="Token usage and cache effectiveness" fullWidth>
     <CostBreakdown data={costAnalytics} />
   </Section>
   ```

2. **Two-column grid** for Version Trajectory and Batch Trends:
   ```jsx
   <div className="grid-2col" style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 24, marginTop: 24 }}>
   ```

   - Left: **Version Trajectory (ANLZ-01)** -- Section with title "Version Health Trajectory". Include a `<select>` dropdown above the chart to pick a workflow:
     ```jsx
     <Section title="Version Health Trajectory" subtitle="Health score changes across re-analyses">
       {versionedWorkflows.length > 0 ? (
         <>
           <select value={selectedTrajectoryId || ""} onChange={(e) => setSelectedTrajectoryId(e.target.value)}
             style={{ width: "100%", padding: "8px 12px", marginBottom: 16, borderRadius: "var(--radius-sm)", border: "1px solid var(--color-border)", background: "var(--color-surface)", fontFamily: "var(--font-mono)", fontSize: 12, color: "var(--color-dark)" }}>
             {versionedWorkflows.map(w => (
               <option key={w.id} value={w.id}>{w.decomposition.title} (v{w.version || 1})</option>
             ))}
           </select>
           <VersionTrajectoryChart data={versionTrajectory} />
         </>
       ) : (
         <div style={{ fontFamily: "var(--font-body)", fontSize: 13, color: "var(--color-muted)", padding: "24px 0", textAlign: "center" }}>
           Re-analyze a workflow to see version health trajectory
         </div>
       )}
     </Section>
     ```

   - Right: **Batch Trends (ANLZ-02)**:
     ```jsx
     <Section title="Library Health Trends" subtitle="Aggregate health across all workflows">
       <BatchTrendsChart data={batchTrends} />
     </Section>
     ```

   Close the two-column grid div.

3. **Gap Heatmap (ANLZ-04)** -- full width Section, title "Gap Frequency Patterns", below the two-column grid:
   ```jsx
   <div style={{ marginTop: 24 }}>
     <Section title="Gap Frequency Patterns" subtitle={`Gap distribution across ${workflows.length} workflows`} fullWidth>
       <GapHeatmap data={gapPatterns} totalWorkflows={workflows.length} />
     </Section>
   </div>
   ```

Close the Advanced Analytics container div.

**Important notes:**
- Do NOT modify any existing dashboard sections -- only add new sections after the existing "Workflow Volume" section.
- Do NOT add any new API fetch calls. All analytics are computed from the existing `workflows` state.
- The `grid-2col` className is already defined by existing CSS in the project and handles responsive collapse to single column.
  </action>
  <verify>
Run `npx tsc --noEmit` from project root -- entire project compiles with no type errors. Verify dashboard page imports all 4 analytics components and all 4 compute functions. Run `npm run build` -- if it fails due to OneDrive path issue (known blocker), verify `tsc --noEmit` passes instead and note the known issue.
  </verify>
  <done>
Dashboard page at `/dashboard` renders all 4 new analytics sections: (1) API cost breakdown with cache savings, (2) version health trajectory with workflow selector dropdown, (3) library-wide batch health trends, (4) gap frequency heatmap with severity visualization. All computed client-side from existing workflow data. No new API routes. Existing dashboard sections are unchanged.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors across the entire project
- Dashboard page imports and renders: VersionTrajectoryChart, BatchTrendsChart, CostBreakdown, GapHeatmap
- Dashboard page calls: computeVersionTrajectory, computeBatchTrends, computeCostAnalytics, computeGapPatterns
- No new `fetch()` calls added to dashboard (all analytics from existing workflows state)
- Version trajectory has a workflow selector dropdown
- All 4 new sections appear after existing dashboard content
- Empty states are handled (no crashes with 0 workflows or 0 versioned workflows)
</verification>

<success_criteria>
- ANLZ-01: Dashboard shows version health trajectory line chart with workflow selector
- ANLZ-02: Dashboard shows batch comparison summary stats and weekly health bar chart
- ANLZ-03: Dashboard shows API cost breakdown with total tokens, cost, cache hits, and estimated savings
- ANLZ-04: Dashboard shows gap frequency heatmap with severity-colored blocks per gap type
- All 4 sections render below existing dashboard content under "Advanced Analytics" header
- No server-side routes (all client-side per project decision)
- Project compiles with TypeScript no errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-advanced-analytics/07-02-SUMMARY.md`
</output>
