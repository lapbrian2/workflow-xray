---
phase: 07-advanced-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/analytics.ts
  - src/components/analytics/version-trajectory.tsx
  - src/components/analytics/batch-trends.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "computeVersionTrajectory returns chronologically ordered health scores for a single workflow's version chain"
    - "computeBatchTrends returns aggregate health deltas across all workflows that have version chains"
    - "computeCostAnalytics returns total tokens, total cost, cache hit count, and estimated savings"
    - "computeGapPatterns returns gap frequency data grouped by gap type with severity breakdown"
    - "VersionTrajectory component renders a Recharts LineChart showing health metric changes across versions"
    - "BatchTrends component renders aggregate comparison metrics with delta indicators"
  artifacts:
    - path: "src/lib/analytics.ts"
      provides: "All 4 analytics computation functions"
      exports: ["computeVersionTrajectory", "computeBatchTrends", "computeCostAnalytics", "computeGapPatterns"]
    - path: "src/components/analytics/version-trajectory.tsx"
      provides: "ANLZ-01 version health trajectory LineChart"
      min_lines: 40
    - path: "src/components/analytics/batch-trends.tsx"
      provides: "ANLZ-02 batch comparison trends display"
      min_lines: 40
  key_links:
    - from: "src/lib/analytics.ts"
      to: "src/lib/types.ts"
      via: "imports Workflow, Gap, HealthMetrics types"
      pattern: "import.*from.*@/lib/types"
    - from: "src/components/analytics/version-trajectory.tsx"
      to: "src/lib/analytics.ts"
      via: "uses VersionTrajectoryPoint return type"
      pattern: "import.*from.*@/lib/analytics"
    - from: "src/components/analytics/batch-trends.tsx"
      to: "src/lib/analytics.ts"
      via: "uses BatchTrendData return type"
      pattern: "import.*from.*@/lib/analytics"
---

<objective>
Create the analytics computation engine and the first two analytics visualization components for ANLZ-01 (version health trajectories) and ANLZ-02 (batch comparison trends).

Purpose: Establish all four analytics pure functions in a single module, then build the two health-metric-focused visualizations that let users see how individual workflow health changes across versions and how health improves across the entire workflow library.

Output: `src/lib/analytics.ts` with all computation functions, plus two Recharts-based visualization components.
</objective>

<execution_context>
@C:/Users/Brian/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Brian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/lib/types.ts
@src/lib/chart-data.ts
@src/components/health-trend-chart.tsx
@src/app/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics computation engine (all 4 functions)</name>
  <files>src/lib/analytics.ts</files>
  <action>
Create `src/lib/analytics.ts` with four exported pure functions. All operate on `Workflow[]` arrays (client-side, no server routes per project decision). Import types from `@/lib/types`.

**1. `computeVersionTrajectory(workflows: Workflow[], workflowId: string): VersionTrajectoryPoint[]`**
- Given a workflow ID, walk the version chain: find the workflow, then find all workflows sharing the same root ancestor by following `parentId` links up to the root, then collecting all descendants.
- Algorithm: (a) Start from the given workflowId, walk `parentId` up to find the root (workflow with no parentId or parentId not in the set). (b) Then BFS/filter all workflows whose parentId chain leads to that root. (c) Sort by `version` field (ascending), falling back to `createdAt` if version is missing.
- Return array of `VersionTrajectoryPoint`: `{ version: number, label: string, createdAt: string, complexity: number, fragility: number, automationPotential: number, teamLoadBalance: number, overallHealth: number }`.
- `overallHealth` formula matches existing `chart-data.ts`: `Math.round((complexity + (100 - fragility) + automationPotential + teamLoadBalance) / 4)`.
- `label` = `"v${version}"` or `"v1"`, `"v2"`, etc.
- Return empty array if workflow not found or no version chain (single version = array of 1 element, still useful).

**2. `computeBatchTrends(workflows: Workflow[]): BatchTrendData`**
- Aggregate health metrics across ALL workflows to show library-wide trends.
- Group workflows by week (same bucketing logic as `computeHealthTrends` in chart-data.ts -- reuse the ISO week start calculation).
- For each weekly bucket, compute: average complexity, average fragility, average automationPotential, average teamLoadBalance, workflow count.
- Also compute: total workflows with version chains (have parentId), total health improvement (compare first version to latest version health for each chain, average the deltas).
- Return `BatchTrendData`: `{ weeklyTrends: WeeklyTrendPoint[], versionedWorkflowCount: number, averageHealthImprovement: number, totalWorkflows: number }`.
- `WeeklyTrendPoint`: `{ date: string, label: string, count: number, avgComplexity: number, avgFragility: number, avgAutomation: number, avgTeamBalance: number, avgOverallHealth: number }`.

**3. `computeCostAnalytics(workflows: Workflow[]): CostAnalyticsData`**
- Sum `tokenUsage.inputTokens` and `tokenUsage.outputTokens` across all workflows (skip workflows without tokenUsage).
- Count total analyses, cache hits (`cacheHit === true`), and cache misses.
- Compute estimated cost using Sonnet pricing: input = $3.00/MTok, output = $15.00/MTok (these are approximate; use constants at top of file for easy updating).
- Compute estimated savings: `cacheHitCount * averageCostPerAnalysis` (where averageCostPerAnalysis = totalCost / totalNonCachedAnalyses).
- Return `CostAnalyticsData`: `{ totalInputTokens: number, totalOutputTokens: number, totalCost: number, totalAnalyses: number, cacheHits: number, cacheMisses: number, estimatedSavings: number, costPerAnalysis: number }`.

**4. `computeGapPatterns(workflows: Workflow[]): GapPatternData[]`**
- Flatten all gaps from all workflows.
- Group by `gap.type` (GapType).
- For each type, count total occurrences and breakdown by severity (high/medium/low).
- Also compute: percentage of workflows affected (how many workflows have at least one gap of this type), and list of unique `impactedRoles` across all gaps of this type.
- Return sorted by total count descending.
- `GapPatternData`: `{ type: GapType, label: string, total: number, severities: { high: number, medium: number, low: number }, workflowsAffected: number, percentAffected: number, impactedRoles: string[] }`.
- Use `GAP_LABELS` from `@/lib/types` for the `label` field.

Export all types (`VersionTrajectoryPoint`, `BatchTrendData`, `WeeklyTrendPoint`, `CostAnalyticsData`, `GapPatternData`) so components can import them.

Define cost constants at top of file:
```typescript
const COST_PER_MTOK_INPUT = 3.0;   // $/MTok for Claude Sonnet
const COST_PER_MTOK_OUTPUT = 15.0;  // $/MTok for Claude Sonnet
```
  </action>
  <verify>
Run `npx tsc --noEmit` from project root -- file compiles with no type errors. Verify the file exports all 4 functions and 5 types by checking the export statements.
  </verify>
  <done>
`src/lib/analytics.ts` exists with 4 exported pure functions and 5 exported types. All functions accept `Workflow[]` and return typed results. Cost constants are defined. overallHealth formula matches existing chart-data.ts convention.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ANLZ-01 version trajectory and ANLZ-02 batch trends components</name>
  <files>src/components/analytics/version-trajectory.tsx, src/components/analytics/batch-trends.tsx</files>
  <action>
Create `src/components/analytics/` directory if it does not exist.

**version-trajectory.tsx (ANLZ-01):**
- `"use client"` directive at top.
- Import `LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer` from `recharts` (same pattern as existing `health-trend-chart.tsx`).
- Import `VersionTrajectoryPoint` from `@/lib/analytics`.
- Props: `{ data: VersionTrajectoryPoint[] }`.
- Renders a Recharts `LineChart` inside `ResponsiveContainer` (width="100%", height={280}).
- Show 4 metric lines: complexity (blue #2D7DD2), fragility (red #E8553A), automationPotential (green #17A589), teamLoadBalance (purple #8E44AD) -- same colors as existing `health-trend-chart.tsx`.
- Also show a 5th line for `overallHealth` (dashed, color #333 or var(--color-dark), strokeDasharray="5 5", strokeWidth=2.5) to highlight the composite score.
- X-axis uses `label` field (e.g., "v1", "v2", "v3").
- Y-axis domain [0, 100].
- Use same Tooltip styling as health-trend-chart.tsx (surface background, border, mono font, 11px).
- If data has fewer than 2 points, render a styled message: "Re-analyze this workflow to see version health trajectory" -- use mono font, muted color, centered, padded.
- Component name: `VersionTrajectoryChart`, default export.

**batch-trends.tsx (ANLZ-02):**
- `"use client"` directive at top.
- Import `BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer` from `recharts`.
- Import `BatchTrendData` from `@/lib/analytics`.
- Props: `{ data: BatchTrendData }`.
- Layout: Two sections stacked vertically.
  - **Top section**: 3 summary stat cards in a row (use inline styles matching existing dashboard HealthStat pattern -- surface background, border, rounded corners, center-aligned).
    - Card 1: "Versioned Workflows" -- `data.versionedWorkflowCount` out of `data.totalWorkflows` (e.g., "8 / 42 workflows")
    - Card 2: "Avg Health Improvement" -- `data.averageHealthImprovement` as a signed number with + prefix if positive (e.g., "+12 pts" or "-3 pts"). Color green if positive, red if negative, muted if zero.
    - Card 3: "Total Analyzed" -- `data.totalWorkflows` (e.g., "42 workflows")
  - **Bottom section**: If `data.weeklyTrends.length >= 2`, render a Recharts `BarChart` showing `avgOverallHealth` per week. Single bar series, color #2D7DD2 (info blue). X-axis = `label`, Y-axis domain [0, 100]. Same tooltip styling as other charts. If fewer than 2 weeks of data, show a message "Analyze more workflows over time to see batch trends."
- Component name: `BatchTrendsChart`, default export.

Match the existing project styling conventions:
- `fontFamily: "var(--font-mono)"` for data/labels
- `fontSize: 10-12` for chart labels
- `var(--color-border)`, `var(--color-surface)`, `var(--color-muted)` for chrome
- `border: "1px solid var(--color-border)"`, `borderRadius: "var(--radius-sm)"`
  </action>
  <verify>
Run `npx tsc --noEmit` from project root -- both component files compile with no type errors. Verify both files exist and export default components.
  </verify>
  <done>
Two components exist: `version-trajectory.tsx` renders a multi-line Recharts chart for per-workflow version health, `batch-trends.tsx` renders summary stats plus a weekly bar chart for library-wide health trends. Both import types from `analytics.ts` and follow existing project styling conventions.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `src/lib/analytics.ts` exports: computeVersionTrajectory, computeBatchTrends, computeCostAnalytics, computeGapPatterns
- `src/components/analytics/version-trajectory.tsx` default-exports VersionTrajectoryChart
- `src/components/analytics/batch-trends.tsx` default-exports BatchTrendsChart
- All imports resolve (types from @/lib/types, recharts components, analytics types)
</verification>

<success_criteria>
- Analytics engine has 4 pure functions covering all 4 ANLZ requirements
- ANLZ-01 component renders version chain health trajectory as a line chart
- ANLZ-02 component renders batch summary stats and weekly health bar chart
- All code compiles without TypeScript errors
- No server-side routes created (all client-side per project decision)
</success_criteria>

<output>
After completion, create `.planning/phases/07-advanced-analytics/07-01-SUMMARY.md`
</output>
